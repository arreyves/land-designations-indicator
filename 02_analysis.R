# Copyright 2016 Province of British Columbia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.


library(rgdal)
library(sp)
library(rgeos)
library(raster)
library(rmapshaper)
library(ggplot2)
library(ggthemes)
library(dplyr)
library(tidyr)
library(feather)
library(bcmaps)
library(readr)

source("fun.R")

dir.create("out", showWarnings = FALSE)

# ld <- readRDS("tmp/mock_spatial.rds")
ld_agg <- readRDS("tmp/mock_spatial_agg.rds")
ld_agg_simp <- readRDS("tmp/mock_spatial_agg_simp.rds")

ecoreg <- readRDS("tmp/ecoregions_t.rds")
ecoreg_simp <- readRDS("tmp/ecoregions_t_simp.rds")

bec <- readRDS("tmp/bec_t.rds")
bec_zone <- readRDS("tmp/bec_zone.rds")
bec_zone_simp <- readRDS("tmp/bec_zone_simp.rds")

ld_agg$area <- gArea(ld_agg, byid = TRUE)

## BC Summary
bc_ld_summary <- ld_agg@data %>%
  group_by(cons_cat) %>%
  summarise(area_des = sum(area, na.rm = TRUE)) %>%
  mutate(CRGNCD = "BC",
         percent_des = area_des / bc_area(units = "m2") * 100,
         area_des_ha = area_des * 1e-4) %>%
  write_feather("out/bc_ld_summary.feather")

## Intersect land designations with ecoregions and summarize.
## Uses readr::write_rds instead of saveRDS because the former returns the value
ld_x_ecoreg_tempfile <- "tmp/ld_x_ecoreg.rds"
ld_x_ecoreg <- tryCatch(readRDS(ld_x_ecoreg_tempfile),
                        error = function(e) {
                          raster::intersect(ecoreg, ld_agg) %>%
                            write_rds(ld_x_ecoreg_tempfile)
                        })

ld_x_ecoreg$area <- rgeos::gArea(ld_x_ecoreg, byid = TRUE)

ld_ecoreg_summary <- ld_x_ecoreg@data %>%
  group_by(CRGNCD, cons_cat) %>%
  summarise(area_des = sum(area, na.rm = TRUE)) %>%
  left_join(group_by(ecoreg@data, CRGNCD) %>%
              summarize(ecoreg_area = sum(area, na.rm = TRUE)), by = "CRGNCD") %>%
  mutate(percent_des = area_des / ecoreg_area * 100,
         area_des_ha = area_des * 1e-4) %>%
  write_feather("out/ld_ecoreg_summary.feather")

# Intersect simplified versions for mapping display
ld_x_ecoreg_simp <- raster::intersect(ld_agg_simp, ecoreg_simp)

gg_ld_x_ecoreg <- gg_fortify(ld_x_ecoreg_simp) %>% write_feather("out/gg_ld_ecoreg.feather")

# ecoreg_cds <- unique(gg_ecoreg$CRGNCD)
#
# lapply(ecoreg_cds, gg_ld_ecoreg, gg_ld_x_ecoreg, gg_ecoreg)

################################################################################
# BEC

## Intersect land designations with BEC and summarize
ld_x_bec_tempfile <- "tmp/ld_x_bec.rds"
ld_x_bec <- tryCatch(readRDS(ld_x_bec_tempfile),
                     error = function(e) {
                       raster::intersect(bec, ld_agg) %>%
                         write_rds(ld_x_bec_tempfile)
                     })

ld_x_bec$area <- rgeos::gArea(ld_x_bec, byid = TRUE)

ld_bec_summary <- ld_x_bec@data %>%
  group_by(MAP_LABEL, cons_cat = factor(cons_cat)) %>%
  summarise(area_des = sum(area, na.rm = TRUE)) %>%
  right_join(group_by(bec@data, MAP_LABEL, ZONE, ZONE_NAME, SUBZONE, SBZNNM,
                     VARIANT, VRNTNM) %>%
              summarize(bec_area = sum(area, na.rm = TRUE)), by = "MAP_LABEL") %>%
  mutate(percent_des = area_des / bec_area * 100,
         area_des_ha = area_des * 1e-4) %>%
  complete(nesting(MAP_LABEL, ZONE, ZONE_NAME, SUBZONE, SBZNNM,
                 VARIANT, VRNTNM, bec_area), cons_cat,
           fill = list(area_des = 0, area_des_ha = 0, percent_des = 0)) %>%
  mutate(cons_cat = as.character(cons_cat)) %>%
  write_feather("out/ld_bec_summary.feather")

# Intersect simplified versions for mapping display
ld_x_bec_simp <- raster::intersect(ld_agg_simp, bec_zone_simp)

gg_ld_x_bec <- gg_fortify(ld_x_bec_simp) %>% write_feather("out/gg_ld_bec.feather")

####################################
# ecoregions_list <- lapply(ecoreg$CRGNCD, function(x) {
#   ecoreg[ecoreg$CRGNCD == x,]
# })
#
# names(ecoregions_list) <- ecoreg$CRGNCD
#
# # This takes about 30 minutes
# # ld_ecoreg_clip_list <- lapply(ecoregions_list, function(x) {
# #   rmapshaper::ms_clip(ld_agg, x)
# # })
#
# names(ld_ecoreg_clip_list) <- ecoreg$CRGNCD
#
# lapply(names(ld_ecoreg_clip_list), plot_ecoreg_land_des, ecoregions_list, ld_ecoreg_clip_list)

